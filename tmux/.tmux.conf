unbind r
bind r source-file ~/.tmux.conf

set -g base-index 1
set -g renumber-windows on

set -g prefix C-a
bind a send-prefix
set -g mouse on
set -g mode-keys vi

# Faster escape time for vim/nvim responsiveness
set -s escape-time 0

# Terminal and color support for Claude Code output
set -g default-terminal "tmux-256color"
set-option -ga terminal-overrides ",*:Tc"

# Large scrollback for Claude Code verbose output
set -g history-limit 50000

# Allow OSC passthrough for notifications inside tmux (3.3+)
set -g allow-passthrough on

# Extended keys for Shift+Enter, Ctrl+Enter etc. in CLI tools (3.2+)
set -g extended-keys on
set -as terminal-features ',xterm-256color:extkeys'
set -as terminal-features ',xterm-ghostty:extkeys'



# Undercurl support for better terminal rendering (LSP diagnostics, etc.)
set -as terminal-overrides ',*:Setulc=%p1%s\a'


# Neovim integration across panes
set -g focus-events on

bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

# Kill pane without confirmation (for Cmd+W in Ghostty)
bind-key x kill-pane

# Split panes preserving current path
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# New windows also preserve current path
bind c new-window -c "#{pane_current_path}"

# Repeatable pane resizing (no need to press prefix each time)
bind -r Left resize-pane -L 10
bind -r Right resize-pane -R 10
bind -r Down resize-pane -D 5
bind -r Up resize-pane -U 5

# Utility bindings
bind-key C-j command-prompt -p "move pane to:" "join-pane -t '%%'"
bind-key C-h split-window -v "btop"
bind-key t split-window -v "nvim ~/todo.md"

# FZF file picker popup - inserts selected files as comma-separated list
bind-key m popup -B -E -d "#{pane_current_path}" "tmux send-keys -l \"$(fzf -m --border --layout=reverse-list --style=minimal --bind 'ctrl-d:reload(fd --type d --hidden --follow --exclude \".git\"),ctrl-f:reload(eval \"$FZF_DEFAULT_COMMAND\")' | sed 's/\$/, /' | xargs | sed 's/,\$//')\""

# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'christoomey/vim-tmux-navigator'

# Extend vim-tmux-navigator to also detect Pi/Claude agents for C-j passthrough
# Pi needs C-j passed through for Shift+Enter (newline) support
set -g @vim_navigator_pattern '(\S+/)?g?\.?(view|l?n?vim?x?|fzf|pi|claude)(diff)?(-wrapped)?'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'dracula/tmux'

# tmux-yank: exit copy mode after yanking (default behavior)
set -g @yank_action 'copy-pipe-and-cancel'
# Resurrect/Continuum must load AFTER themes that override status-right
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# Restore sessions automatically on tmux server start
set -g @continuum-restore 'on'
# Save session every 15 minutes
set -g @continuum-save-interval '15'

set -g @dracula-show-powerline true
set -g @dracula-show-flags true
set -g @dracula-show-left-icon session
set -g @dracula-plugins "git cpu-usage ram-usage battery time"
set -g @dracula-show-timezone false
set -g @dracula-military-time true
set -g status-position top

# Git-aware pane borders: show directory + git branch
set -g pane-border-format "#(echo \"#{b:pane_current_path}\" | cut -c1-24)#(cd #{pane_current_path} && git rev-parse --abbrev-ref HEAD 2>/dev/null | awk '{print \" \"substr($0,1,24)\"\"}')"

# Window names: show directory + git branch (instead of process name)
set -g automatic-rename-format "#(echo \"#{b:pane_current_path}\" | cut -c1-24)#(cd #{pane_current_path} && git rev-parse --abbrev-ref HEAD 2>/dev/null | awk '{print \" \"substr($0,1,24)\"\"}')"
set -g automatic-rename on

# PT keyboard friendly rebinds (avoid [ ] { })
bind v copy-mode            # enter copy mode (was [)
unbind p
bind p paste-buffer         # paste (was ])
bind < swap-pane -U         # swap pane up (was {)
bind > swap-pane -D         # swap pane down (was })

# Vi-mode copy bindings: v for visual selection, y for yank to clipboard
bind-key -T copy-mode-vi 'v' send-keys -X begin-selection
bind-key -T copy-mode-vi 'y' send-keys -X copy-pipe-and-cancel 'pbcopy'
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel 'pbcopy'

# Window switching (prev-window moved to C-p only since p is now paste)
bind C-p previous-window
bind C-n next-window

# Direct window switching with Ctrl+1 through Ctrl+5
bind-key -n F1 select-window -t 1
bind-key -n F2 select-window -t 2
bind-key -n F3 select-window -t 3
bind-key -n F4 select-window -t 4
bind-key -n F5 select-window -t 5

run '~/.tmux/plugins/tpm/tpm'

# Toggle sticky yank: prefix + y switches between exit/stay in copy mode after yank
# Overrides tmux-yank's copy_line which breaks Fish shell
bind y if-shell '[ "$(tmux show -gqv @yank-sticky)" = on ]' {
    set -g @yank-sticky off
    set -g @yank_action copy-pipe-and-cancel
    bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'pbcopy'
    bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel 'pbcopy'
    display-message 'Yank: exit copy mode'
} {
    set -g @yank-sticky on
    set -g @yank_action copy-pipe
    bind-key -T copy-mode-vi y send-keys -X copy-pipe 'pbcopy'
    bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe 'pbcopy'
    display-message 'Yank: stay in copy mode'
}

